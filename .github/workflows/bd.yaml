name: üé≤ Preparando dados para construir o Banco de Dados da aplica√ß√£o

on:
  workflow_dispatch:
  push:
    branches: ["main"]

permissions:
  contents: write

jobs:
  send-data-bd:
    name: Enviando dados para construir o banco de Dados do seu projeto
    runs-on: ubuntu-latest
    permissions: 
      contents: write
    steps:
      - uses: actions/checkout@v5.0.0
        with:
          fetch-depth: 0
          token: ${{ secrets.TAG_GITHUB_TOKEN }}
      
      - name: Preparando tudo para enviar os dados necess√°rios para a cria√ß√£o do BD - Secrets
        id: arquivo-deploy-secrets
        run: |
          git config --global user.name "[bot]-actions"
          git config --global user.email "[bot]-actions@users.noreply.github.com"

          # definindo a branch "main"
          git config --global init.defaultBranch main
          
          resolved_env=".deploy.resolved.env"
          cp .deploy.env $resolved_env

          # Extraindo os placeholders no formato @NOME_SEGREDO@
          vars=$(grep -oE '@[A-Z0-9_]+@' .deploy.env | tr -d '@' | sort -u)

          # Secrets dispon√≠veis em JSON
          ALL_SECRETS='${{ toJson(secrets) }}'

          for var in $vars; do
            value=$(jq -r --arg key "$var" '.[$key]' <<< "$ALL_SECRETS")
            if [ "$value" = "null" ]; then
              echo "‚ùå Secret '$var' n√£o encontrado no reposit√≥rio!"
              exit 1
            fi

            sed -i "s|@$var@|$value|g" $resolved_env
            echo "${var}=${value}" >> $GITHUB_OUTPUT
            echo "PWD_BD=${value}" >> $GITHUB_OUTPUT 
          done

      - name: Preparando as vari√°veis complementares para criar o BD
        id: deploy_env
        run: |
          while IFS=$'\n' read -r line; do
            if [[ -n "$line" && "$line" != \#* ]]; then
              IFS='=' read -r key value <<< "$line"
                # echo "${key}=${value}"
              echo "${key}=${value}" >> $GITHUB_OUTPUT
            fi
          done < .deploy.env

      - name: üì¨ Preparando dados para reposit√≥rio de Infra
        env:
          NOME_PROJETO: ${{ steps.deploy_env.outputs.NOME_DO_PROJETO }}
          REPOSITORIO_INFRA: "Deploy-to-RNP-K8s-Cluster/repoInfra"
        run: |
          PROJETO_PATH="projetos/$NOME_PROJETO/bd"

          NOVA_SECRET_NAME="BD_${NOME_PROJETO}_PWD"
          sed -i -E "s/@[^@]+@/@${NOVA_SECRET_NAME}@/" .deploy.env

          echo ${{ secrets.TAG_GITHUB_TOKEN }}   | gh auth login --with-token

          # Criando diret√≥rio tempor√°rio
          WORK_DIR="temp_repo_$(date +%s)"
          mkdir "$WORK_DIR"
          cd "$WORK_DIR"

          # Inicializar reposit√≥rio e adicionar repo remoto
          git init
          git remote add origin "https://${{ secrets.TAG_GITHUB_TOKEN }}@github.com/${REPOSITORIO_INFRA}.git"
          

          # Configurar sparse checkout para estrutura m√≠nima
          git config core.sparseCheckout true
          echo "/*" > .git/info/sparse-checkout
          echo "!/*/" >> .git/info/sparse-checkout
          echo "/projetos/" >> .git/info/sparse-checkout
          
          # Fazer fetch e checkout
          git pull origin main || echo "‚ö†Ô∏è  Pull inicial falhou, continuando..."

          # Criar estrutura de diret√≥rios completa se n√£o existir
          echo "üîç Verificando estrutura de diret√≥rios..."
          if [ ! -d "$PROJETO_PATH" ]; then
            echo "üìÇ Criando estrutura: $PROJETO_PATH"
            mkdir -p "$PROJETO_PATH"
            
            # Garantir que a pasta projetos est√° sendo rastreada
            if [ ! -d "projetos" ]; then
              mkdir -p "projetos"
              touch "projetos/.gitkeep"
            fi
          fi

          # Copiar arquivo
          echo "üìÑ Copiando .deploy.env para $PROJETO_PATH/"
          cp ../.deploy.env "$PROJETO_PATH/"        


          # Commit e push
          git add -A
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è  Nenhuma altera√ß√£o para commitar"
          else
            git commit -m "feat: Adiciona .deploy.env em $PROJETO_PATH"
            git push origin main
            echo "‚úÖ Arquivo enviado com sucesso!"
          fi

          # Limpeza
          cd ..
          rm -rf "$WORK_DIR"

          # Criando Secret no Repo de Infra
          gh secret set $NOVA_SECRET_NAME --body ${{ steps.arquivo-deploy-secrets.outputs.PWD_BD }} --repo $REPOSITORIO_INFRA